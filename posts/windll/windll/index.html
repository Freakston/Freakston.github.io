<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Introduction to DLL - Freakston</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="Introduction to DLL"><meta itemprop=description content="A short introduction to windows DLL"><meta itemprop=datePublished content="2019-12-15T00:00:00+00:00"><meta itemprop=dateModified content="2019-12-15T00:00:00+00:00"><meta itemprop=wordCount content="450"><meta itemprop=keywords content="Windows,Development,"><meta property="og:title" content="Introduction to DLL"><meta property="og:description" content="A short introduction to windows DLL"><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/posts/windll/windll/"><meta property="article:published_time" content="2019-12-15T00:00:00+00:00"><meta property="article:modified_time" content="2019-12-15T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Introduction to DLL"><meta name=twitter:description content="A short introduction to windows DLL"><link href="https://fonts.googleapis.com/css?family=Playfair+Display:700" rel=stylesheet type=text/css><link rel=stylesheet type=text/css media=screen href=http://example.org/css/normalize.css><link rel=stylesheet type=text/css media=screen href=http://example.org/css/main.css><link id=dark-scheme rel=stylesheet type=text/css href=http://example.org/css/dark.css><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=http://example.org/js/main.js></script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=http://example.org/><img src=favc.png alt=Freakston></a></div><h1 class=site-title><a href=http://example.org/>Freakston</a></h1><div class=site-description><p>やめてください <a href=https://twitter.com/Freakst0n>Twitter</a></p><nav class="nav social"><ul class=flat><li><a href=https://github.com/Freakston title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=# class=scheme-toggle id=scheme-toggle></a></li></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/about>About</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>15</span>
<span class=rest>Dec 2019</span></div></div><div class=matter><h1 class=title>Introduction to DLL</h1></div></div><div class=markdown><h2 id=what-is-a-dll-->What is a DLL -</h2><p>A DLL stands for &ldquo;Dynamic Link Library&rdquo;.It acts as a shared library. The executables can use functions from the DLL libraries by importing/attaching the DLL. Dynamic Libraries are libraries that are loaded from another file (typically the DLL file). They are similar in structure to PE, the only difference they have is that they contain export tables. The list of functions that can be loaded is in the export table of the DLL. The functions which do not appear on the export table are private functions. These functions cannot be accessed by other executables.</p><h2 id=basic-dll-template>Basic DLL Template</h2><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  reason_for_call,
                       LPVOID lpReserved
                     )
{
    <span style=color:#00f>switch</span> (reason_for_call)
    {
    <span style=color:#00f>case</span> DLL_PROCESS_ATTACH:
    <span style=color:#00f>case</span> DLL_THREAD_ATTACH:
    <span style=color:#00f>case</span> DLL_THREAD_DETACH:
    <span style=color:#00f>case</span> DLL_PROCESS_DETACH:
        <span style=color:#00f>break</span>;
    }
    <span style=color:#00f>return</span> TRUE;
}

<span style=color:#00f>__declspec</span>(dllexport) <span style=color:#2b91af>int</span> func1(<span style=color:#2b91af>int</span> x) {
    puts(<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>Func1 was called</span><span style=color:#a31515>&#34;</span>);
    <span style=color:#00f>return</span> x;
    }

<span style=color:#00f>__declspec</span>(dllexport) <span style=color:#2b91af>int</span> func2(<span style=color:#2b91af>int</span> x) {
    puts(<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>Func2 was called</span><span style=color:#a31515>&#34;</span>);
    <span style=color:#00f>return</span> x * 2;
}
</code></pre></div><p>In the above template, we have two functions called <strong>func1</strong> and <strong>func2</strong>. The function func1 just prints out that func1 was called Similarily func2 prints that it was called. As mentioned above the main difference in the structure of PE and DLL is the exports section which lists the functions which can be called by another executable. Now let&rsquo;s have a look at the exports section of the above created DLL. The exports section can be viewed using dumpbin. The command to do so is <strong>dumpbin dllname /EXPORTS</strong></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt;dumpbin Testdll.dll /EXPORTS

Microsoft (R) COFF/PE Dumper Version 14.24.28314.0
Copyright (C) Microsoft Corporation.  All rights reserved.

Dump of file Testdll.dll
    
    The section contains the following exports of Testdll.dll
    ordinal  hint    RVA       name
     1         0   00001020    func1
     2         1   00001040    func2
</code></pre></div><p>We see new terms such as ordinal, hint, and RVA. There are two ways of exporting a function from a DLL, one is by using the function name which we have done above and the other one is by using the ordinal number. When we use the ordinal number we cannot use the <strong>__declspec(dllexport)</strong> we will have to .def the function with the ordinal number. For those interested in knowing more about this method can refer to <a href="https://docs.microsoft.com/en-us/cpp/build/exporting-from-a-dll-using-def-files?view=vs-2019">MSDN official documentation</a>.</p><h2 id=an-executable-which-loads-the-dll>An executable which loads the DLL</h2><p>Now that we have the DLL ready let&rsquo;s write an executable that loads functions from the above-created DLL.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#00f>#</span><span style=color:#00f>include</span><span style=color:#00f>&lt;windows.h&gt;</span><span style=color:#00f>
</span><span style=color:#00f></span>
<span style=color:#00f>typedef</span> int (*ptr_func1)(<span style=color:#2b91af>int</span> x);

ptr_func1 fn1;
ptr_func1 fn2;

HMODULE Testdll;
<span style=color:#2b91af>int</span> main()
{
    Testdll = LoadLibrary(<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>Testdll.dll</span><span style=color:#a31515>&#34;</span>);
    fn1 = (ptr_func1)GetProcAddress(Testdll,<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>func1</span><span style=color:#a31515>&#34;</span>);
    fn2 = (ptr_func1)GetProcAddress(Testdll,<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>func2</span><span style=color:#a31515>&#34;</span>);

    <span style=color:#2b91af>int</span> x = 20;
    fn1(x);
    fn2(x);

    FreeLibrary(Testdll);
}
</code></pre></div><ul><li>HMODULE is going to have the handle to the loaded DLL.</li><li>LoadLibrary is used to load the DLL.</li><li>FreeLibrary is used to free the library has been loaded after the use.</li></ul><h2 id=references>References</h2><ul><li><a href="https://docs.microsoft.com/en-us/cpp/build/exporting-from-a-dll-using-declspec-dllexport?view=vs-2019">https://docs.microsoft.com/en-us/cpp/build/exporting-from-a-dll-using-declspec-dllexport?view=vs-2019</a></li><li><a href=https://docs.microsoft.com/en-us/windows/win32/dlls/dllmain>https://docs.microsoft.com/en-us/windows/win32/dlls/dllmain</a></li></ul></div><div class=tags><ul class=flat><li><a href=/tags/windows>Windows</a></li><li><a href=/tags/development>Development</a></li></ul></div></div></div><div class="footer wrapper"><nav class=nav><div>2021 ©Freakston Copyright notice | <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div></nav></div><script>feather.replace()</script></body></html>
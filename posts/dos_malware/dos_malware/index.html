<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>A look at DOS Malware ABR-1171.COM - Freakston</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="A look at DOS Malware ABR-1171.COM"><meta itemprop=description content="A brief post about ABR-1171"><meta itemprop=datePublished content="2021-01-12T00:00:00+00:00"><meta itemprop=dateModified content="2021-01-12T00:00:00+00:00"><meta itemprop=wordCount content="457"><meta itemprop=keywords content="Malware,DOS,"><meta property="og:title" content="A look at DOS Malware ABR-1171.COM"><meta property="og:description" content="A brief post about ABR-1171"><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/posts/dos_malware/dos_malware/"><meta property="article:published_time" content="2021-01-12T00:00:00+00:00"><meta property="article:modified_time" content="2021-01-12T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="A look at DOS Malware ABR-1171.COM"><meta name=twitter:description content="A brief post about ABR-1171"><link href="https://fonts.googleapis.com/css?family=Playfair+Display:700" rel=stylesheet type=text/css><link rel=stylesheet type=text/css media=screen href=http://example.org/css/normalize.css><link rel=stylesheet type=text/css media=screen href=http://example.org/css/main.css><link id=dark-scheme rel=stylesheet type=text/css href=http://example.org/css/dark.css><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=http://example.org/js/main.js></script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=http://example.org/><img src=favc.png alt=Freakston></a></div><h1 class=site-title><a href=http://example.org/>Freakston</a></h1><div class=site-description><p>やめてください <a href=https://twitter.com/Freakst0n>Twitter</a></p><nav class="nav social"><ul class=flat><li><a href=https://github.com/Freakston title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=# class=scheme-toggle id=scheme-toggle></a></li></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/about>About</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>12</span>
<span class=rest>Jan 2021</span></div></div><div class=matter><h1 class=title>A look at DOS Malware ABR-1171.COM</h1></div></div><div class=markdown><p>In this post we will be looking at how ABR-1171 works.</p><hr><h2 id=environment-setup->Environment setup →</h2><ul><li>Grab the latest version of DOSBox and install it. <a href="https://www.dosbox.com/download.php?main=1">Link</a></li><li>Grab the version of Debug build of DOSBox and place it in the installation folder. <a href="https://www.vogons.org/viewtopic.php?t=7323">Link</a></li></ul><p>Upon opening the file in a disassembler we can see that the first instruction is a jump to the unpacking routine. The unpacking routine can be replicated fairly easily since it&rsquo;s a simple XOR. The IDApy script for unpacking is as follows.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#00f>from</span> idautils <span style=color:#00f>import</span> *
<span style=color:#00f>from</span> idc <span style=color:#00f>import</span> *
<span style=color:#00f>from</span> idaapi <span style=color:#00f>import</span> *

ea = 0x10100 <span style=color:green># This is the start address of Seg000</span>
end_ea = get_segm_end(ea)

patch_byte(ea,0x29)
patch_byte(ea+1,0xd8)
patch_byte(ea+2,0xc1)

<span style=color:#00f>for</span> i <span style=color:#00f>in</span> range(0,586,2):
	patch_byte(ea+i,(get_wide_byte(ea+i) ^ 0xc1))
	patch_byte(ea+i+1,(get_wide_byte(ea+i+1) ^ 0xd7))

plan_and_wait(ea,end_ea)
</code></pre></div><p>Now let&rsquo;s look at what the malware does.</p><h2 id=function---tone>Function - Tone</h2><p>This function is responsible for playing the tone. In the function we check if the speaker is on or not.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>seg000:0129                 in      al, 61h
seg000:012B                 test    al, 3
seg000:012D                 jnz     plat_tone
seg000:012F                 or      al, 3
seg000:0131                 out     61h, al
</code></pre></div><p>Once this is done the malware sets the frequency of tones.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>seg000:0144                 int     1Ah       
seg000:0146                 add     bx, dx
loop_back:
seg000:0148                 int     1Ah
seg000:014A                 cmp     dx, bx
seg000:014C                 jnz     loop_back
</code></pre></div><p>The <code>interrupt 1Ah with AH 0</code> returns the time, which is then compared until we hit the time set in the BX register. Once this is done we reset the speaker and return back.</p><h2 id=function---find-all-files>Function - Find all files</h2><p>This function is responsible for finding all the <code>.exe</code> files in a particular directory and overwriting with the malware file itself.</p><h2 id=function---replace-doshell>Function - Replace doshell</h2><p>This function is responsible for opening <code>c:\\dos\\dosshell.com</code> and copies the unpacked malware into it.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>seg000:018B                 mov     dx, 1B2h      ; Name of file
seg000:018E                 xor     cx, cx
seg000:0190                 mov     ax, 3C02h
seg000:0193                 int     21h           ; Open file   
seg000:0195                 xchg    ax, bx
seg000:0196                 mov     ah, 40h ; 
seg000:0198                 mov     cx, 493h      ; len of bytes to write
seg000:019B                 mov     dx, 100h      ; OEP of malware
seg000:019E                 int     21h           ; write to file       
seg000:01A0                 mov     ah, 3Eh       ; close file
seg000:01A2                 int     21h
</code></pre></div><h2 id=function---output-to-display>Function - Output to display</h2><p>In this function it checks for the video modes. The check for the type of display is done using the interrupt 10, with AH set as 0fh. We see that a particular value is set depending on the value returned by the interrupt. A look at the video memory map of DOS tells us that value is the address of the video memory.  </p><p><img src=Untitled.png alt=Untitled.png></p><p>If the display type is mono then it prints out the string.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>For he is not of this day...Nor he of this mind
</code></pre></div><p>If the display type is a 16bit color mode with res 720x400 it prints out</p><p><img src=Abraxas.png alt=Abraxas.png></p><hr><p><strong>References used:</strong></p><p><a href=http://www2.ift.ulaval.ca/~marchand/ift17583/dosints.pdf>http://www2.ift.ulaval.ca/~marchand/ift17583/dosints.pdf</a></p><p><a href=https://www.osdata.com/system/physical/memmap.htm#MSDOS>https://www.osdata.com/system/physical/memmap.htm#MSDOS</a></p><p><a href=https://www.csee.umbc.edu/courses/undergraduate/211/Spring00/Burt/lectures/CntlHardware/timer.html>https://www.csee.umbc.edu/courses/undergraduate/211/Spring00/Burt/lectures/CntlHardware/timer.html</a></p><p><a href=http://cd.textfiles.com/thegreatunsorted/live_viruses/virus_collections/BBB/>http://cd.textfiles.com/thegreatunsorted/live_viruses/virus_collections/BBB/</a></p></div><div class=tags><ul class=flat><li><a href=/tags/malware>Malware</a></li><li><a href=/tags/dos>DOS</a></li></ul></div></div></div><div class="footer wrapper"><nav class=nav><div>2021 ©Freakston Copyright notice | <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div></nav></div><script>feather.replace()</script></body></html>